<!DOCTYPE html>
<html lang="en">
<head>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eirik Website Eirik</title>
    <link rel="icon" type="image/png" href="imgs/icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Magra:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    button { margin: 1rem 0; }
    ul { list-style-type: none; padding: 0; }
    li { margin-bottom: 0.5rem; }

    .sidenav {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 1;
      top: 0;
      left: 0;
      background-color: #111;
      overflow-x: hidden;
      transition: 0.5s;
      padding-top: 60px;
    }

    .sidenav a {
      padding: 8px 8px 8px 32px;
      text-decoration: none;
      font-size: 25px;
      color: #818181;
      display: block;
      transition: 0.3s;
    }

    .sidenav a:hover {
      color: #f1f1f1;
    }

    .sidenav .closebtn {
      position: absolute;
      top: 0;
      right: 25px;
      font-size: 36px;
      margin-left: 50px;
    }

    @media screen and (max-height: 450px) {
      .sidenav {padding-top: 15px;}
      .sidenav a {font-size: 18px;}
    }
  </style>
</head>
<body>
<!-- Side navigation -->
<div id="mySidenav" class="sidenav">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <a class="active" href="/">Home</a>
  <a href="/questions">Questions</a>
  <a href="/beforewebsite">IETTS</a>
  <a href="/add">Record</a>
</div>

<!-- Open buttons (outside the sidenav) -->
<span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776; open</span>

<!-- JavaScript -->
<script>
function openNav() {
  document.getElementById("mySidenav").style.width = "250px";
}

function closeNav() {
  document.getElementById("mySidenav").style.width = "0";
}

</script>
  <h1>Recordin' time!</h1>
  <p id="wordchosen">Word Chosen:</p>
  <p>Please record like the following intonation:</p>
  <audio controls>
    <source src="5.mp3" type="audio/mpeg">
  </audio>
  <br>
  <br>
  <audio id="player" controls></audio>
  <br>
  <button id="record">Start Recording</button>
  <button id="redo">Redo</button>
  <p id= "moveontext" style="display: none;">Nice! Now to move on. (Unless you'd like to rerecord.)</p>
  <button id= "moveonbutton" style="display: none; margin: 0 auto;">Next Intonation</button>
  <script>
    const params = new URLSearchParams(window.location.search);
    const word = params.get('word');
  
    if (word) {
      document.getElementById('wordchosen').textContent = `Word Chosen: ${word}`;
    }
  </script>
  <script>
function saveToServer(blob) {
  const formData = new FormData();
  formData.append('audio', blob, 'recording.wav');

  fetch('/audio-files', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('Upload successful:', data.filePath);
      alert(`Saved at: ${data.filePath}`);
    } else {
      console.error('Upload failed.');
    }
  })
  .catch(error => console.error('Error uploading:', error));
}
    const recordButton = document.getElementById('record');
    const player = document.getElementById('player');

    let audioContext, mediaRecorder, chunks = [], analyser, source;

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      audioContext = new AudioContext();
      source = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);

      mediaRecorder = new MediaRecorder(stream);
      chunks = [];

      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const arrayBuffer = await blob.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

        const trimmed = trimBuffer(audioBuffer);
        const wavBlob = audioBufferToWavBlob(trimmed);

        const url = URL.createObjectURL(wavBlob);
        player.src = url;
        saveToIndexedDB(wavBlob);
        saveToServer(wavBlob);
      };

      mediaRecorder.start();
      recordButton.textContent = "Recording... (5s)";
      
    function showText() {
      document.getElementById('moveontext').style.display = 'block';
    }
    function showButton() {
      document.getElementById('moveonbutton').style.display = 'block';
    }

    setTimeout(() => {
      mediaRecorder.stop();
      recordButton.textContent = "Start Recording";
      showButton();
      showText();
    }, 5000);
    }

    function trimBuffer(buffer) {
      const raw = buffer.getChannelData(0);
      const threshold = 0.05;
      let start = 0, end = raw.length;

      for (let i = 0; i < raw.length; i++) {
        if (Math.abs(raw[i]) > threshold) {
          start = i;
          break;
        }
      }

      for (let i = raw.length - 1; i >= 0; i--) {
        if (Math.abs(raw[i]) > threshold) {
          end = i;
          break;
        }
      }

      const newBuffer = audioContext.createBuffer(1, end - start, buffer.sampleRate);
      newBuffer.copyToChannel(raw.slice(start, end), 0);
      return newBuffer;
    }

    function audioBufferToWavBlob(buffer) {
      const length = buffer.length;
      const sampleRate = buffer.sampleRate;
      const wavBuffer = new ArrayBuffer(44 + length * 2);
      const view = new DataView(wavBuffer);

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }

      // RIFF chunk
      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + length * 2, true);
      writeString(view, 8, 'WAVE');
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true);
      view.setUint16(20, 1, true);
      view.setUint16(22, 1, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, sampleRate * 2, true);
      view.setUint16(32, 2, true);
      view.setUint16(34, 16, true);
      writeString(view, 36, 'data');
      view.setUint32(40, length * 2, true);

      const channel = buffer.getChannelData(0);
      let offset = 44;
      for (let i = 0; i < channel.length; i++, offset += 2) {
        const s = Math.max(-1, Math.min(1, channel[i]));
        view.setInt16(offset, s * 0x7FFF, true);
      }

      return new Blob([view], { type: 'audio/wav' });
    }

    function saveToIndexedDB(blob) {
  const request = indexedDB.open("audioDB", 1);
  request.onupgradeneeded = event => {
    const db = event.target.result;
    if (!db.objectStoreNames.contains("clips")) {
      db.createObjectStore("clips", { autoIncrement: true });
    }
  };

  request.onsuccess = event => {
         const db = event.target.result;
         const tx = db.transaction("clips", "readwrite");
         const store = tx.objectStore("clips");
         store.add(blob);
         tx.oncomplete = () => db.close();
       };
     }

     document.getElementById("redo").onclick = function () {
       const request = indexedDB.open("audioDB", 1);
       request.onsuccess = event => {
         const db = event.target.result;
         const tx = db.transaction("clips", "readwrite");
         const store = tx.objectStore("clips");
         const cursorRequest = store.openCursor(null, 'prev'); 
         
         cursorRequest.onsuccess = event => {
           const cursor = event.target.result;
           if (cursor) {
             cursor.delete(); 
           }
         };

         tx.oncomplete = () => db.close();
       };
     };

    recordButton.addEventListener('click', startRecording);

    document.getElementById("moveonbutton").onclick = function () {
        location.href = "/beforewebsite/fun/intonation6" + window.location.search;
    };
  </script>
</body>
</html>